<style>
	#statut{
		transition-property: opacity;
		transition-duration: 0.5;
		transition-timing-function: linear;
		position: absolute;
		left: 20px;
		top: 20px;
		background-color: black;
		width: 150px;
		opacity: 0.6;
		border-radius: 0 0 15px 0;
	}
	
	#statut:hover{
		transition-property: opacity;
		transition-duration: 0.5;
		transition-timing-function: linear;
		opacity: 1;
	}
	
	#statut img, #statut div{
		display: inline-block;
	}
	
	#statut img{
		border-radius: 12px;
		margin-right: 10px;
	}
	
	#statut progress{
		display: block;
		width: 120px;
	}
	
	#chakra{
		background-color: rgb(83, 68, 182);
		color: rgb(15, 0, 110);
	}
	
	#vie{
		background-color: rgb(93, 215, 93);
		color: 9, 128, 9;
	}
</style>
<html>
	<head>
		<title>Test menu combat</title>
	</head>
	<div id="statut">
		<img src="uneImageDeTest.png" />
		<div>
			<progress class="chakra" val="" max=""></progress>
			<progress class="vie" val="" max=""></progress>
			<p>Rang : <span class="statut"></span></p>
			<p>Nombre de kills : <span class="nbKills"></span></p>
			<p>Etat : <span class="etat"></span></p>
		</div>
		<!--
			Ce statut sera une partie constamment visible aux yeux du joueur.
		-->
	</div>
	<body>
		<div id="menuCombat">
			<div id="cadre1">
				<div id="coupsStandards">
					<span id="attaqueArme">Attaquer avec mon arme principale</span>
					<span id="attaquePoings">Attaquer à mains nues</span>
				</div>
				<div id="rubriqueTechniquesEtObjets">
					<span id="0">Utiliser un jutsu (taijutsu)</span>
					<span id="1">Utiliser un jutsu (ninjutsu)</span>
					<span id="2">Utiliser un jutsu (genjutsu)</span>
					<span id="3">Utiliser un objet</span>
				</div>
				<div id="manipulationChakra">
					<span id="ajoutChakra1">Intégrer du chakra dans mon arme principale (Gain d'attaque)</span>
					<span id="ajoutChakra2">Intégrer du chakra dans mes pieds (Gain de vitesse)</span>
					<span id="ajoutChakra3">Intégrer du chakra autour de mon corps (Gain de défense)</span>
					<span id="enleverChakra1">Enlever le chakra contenu dans mon arme</span>
					<span id="enleverChakra2">Enlever le chakra contenu dans mes pieds</span>
					<span id="enleverChakra3">Enlever le chakra de mon corps</span>
				</div>
				<div id="changeArme">
					<!--
						Si le joueur peut changer d'arme par l'intermediaire d'un objet
						<span>Changer d'arme</span>
					-->
				</div>
			</div>
			<div id="cadre2">
				<div>
				</div>
				<div>
				</div>
			</div>
		</div>
	</body>
</html>
<script type="text/javascript">
//avoir le nom de l'adversaire
(function(){
	var webSocket = new WebSocket("http://url");
	webSocket.onMessage = function(datas){
		var datasSplit = datas.split("*");
		switch (datasSplit[0]){
			case "combat":
				if (datasSplit[1] == "attaque"){
					//informe l'utilisateur d'esquiver une action
					$("#content").append("<div id=equive><img src=images/esquive.png /><span>Appuyer sur " + (Math.floor(Math.random() * (max - min)) + min)"</span></div>");
					Combat.lanceEsquive(datasSplit);	
				}
				else if (datasSplit[1] == "refreshStatsAdversaire"){
					var stats = datasSplit[2].split("|");
					$(".vie:eq(1)").val(stats[0]);
					$(".chakra:eq(1)").val(stats[1]);
					$(".etat:eq(1)").text(stats[2]);
				}
				else if (datasSplit[1] == "fin")
					toastr.succes("Vous avez gagné contre " + joueur.getAdversaire());
				else{}
			break;
		}
	};
	var Combat = function(){
		
		Combat.prototype.Combat = function(joueurAdverse, mapCombat){
			//integrer le joueur sur la map de combat
			$("#content").html("<img src=" + mapCombat + " id=mapCombat />");
			$("#content").html("< img src=" + joueur.getSkin() + " id=votreJoueur />");
			$("#content").append("img src=" + joueurAdverse + " /> id=joueurAdverse");
			$("#content").append($("#templateMenuCombat").html());
			$("#content").append("<div id=statutAdverse>" + $("#statut").html() + "</div>");
			this.menuCombat = new MenuCombat();
		}
		
		Combat.prototype.lanceEsquive = function(datasSplit){
			$(window).keydown(function(e){
				var estEsquive = null;
				if (estEsquive == null && e.keyCode == "touche e"){
					clearTimeout(timeout);
					$("#content").append($("#retourAttaqueRapide").html());
					estEsquive = true;
					timeout = setTimeout(function(){
						$(window).removeEvent("click");
					}, 2000);
				}
				else{
					if (estEsquive){
						switch (e.keyCode){
							case "toucheT":
								//retour attaque epee
								if (joueur.getArmePrincipale().exist())
									webSocket.send("combat*attaqueSimple*arme*" + joueur.getArmePrincipale().getId());
								else
									webSocket.send("combat*attaqueSimple*poings");
							break;
							case "toucheF":
								//utilisation d'une technique
								if (joueur.getTechniqueALancerApresEsquive().getConsommationChakra() < parseInt($("barreChakra").val()))
									webSocket.send("combat*attaqueJutsu*" + joueur.getTechniqueALancerApresEsquive().getNom());
							break;
						}
					}
				}
			
			});
			var timeout = setTimeout(function(){
				// code a executer si le joueur n'esquive pas
				if (parseInt($("#vie").val()) - parseInt(datasSplit[2]) >= 1){
					$("#vie").val(parseInt($("#vie").val()) - parseInt(datasSplit[2]));
					$("#etat").text(datasSplit[3]); // etat empoisonné, sain ou paralysé par exemple
					if ($("#etat").text() == "empoisonné")
						$("#vie").text(parseInt($("#vie").val()) * 0.9);
					if (parseInt($("#vie").val()) <= 0){
						webSocket.send("combat*fin*perdu");
						toastr.info("Vous avez perdu le combat", "Etat de la partie");
					}
					else
						webSocket.send("combat*statutAdversaire*" + $(".vie:eq(0)").val() + "|" + $(".chakra:eq(0)").val() + $(".statut:eq(0)").text());
				}
				else{
					webSocket.send("combat*fin*perdu");
					toastr.info("Vous avez perdu le combat", "Etat de la partie");
				}
			}, 1500);
		};
		
		return Combat;
	};
})();

$.post("ajax.php"; {"action" : "recupererDonneesPourCombat"}).done(function(datas){

    
/*
Utilisation d'un template : 
<div class="template" id="templateUtilisationChakra>
	<div id="ajouterChakra">
		<p id="action"></p>
		<p>Dose de chakra : <input type="text" id="doseChakra" class="champsAInitialiser" /></p>
		<div>
			<button id="annuler">Annuler</button>
			<button id="valider">Valider</button>
		</div>
	</div>
</div>
	
</div>
<div class="template" id="templateTechnique">
    <span>Nom de la technique : <span class="cible></span></span>
    <span>Points de dégats : <span class="cible"></span></span>
    <span>Consommation de chakra : <span class="cible"></span></span>
</div>
 */
	var MenuPartie2 = (function(){
		MenuPartie2.prototype.MenuPartie2 = function(menuCombatParam)[
			this.position = this.anciennePosition = 0;
			this.pageFin = parseInt($(".page").last().text());
			this.pageCourante = 1;
			this.position = 0;
		}
		MenuPartie2.prototype.init = function(){
			$("#cadre2").focus();
			var self = this;
			$(".page").click(function(){
				self.pageCourante = parseInt($(this).text());
				self.menuCombat.afficherItems(self.indice, self.pageCourante - 1, false);
				$("#pageCible").removeAttr("id");
				$(this).attr("id", "pageCible");
			});
			$("#cadre2").keyup(function(e){
				var pageChange = false;
				if (e.keyCode == 47){
					$(this).attr("class", "cache");
					$("#cadre1").focus();
				}
				else if (e.keyCode == 48 && self.position == 0 && self.pageCourante != -1 || e.keyCode == 48 && self.position != 0 || e.keyCode == 50 && self.position == 10 && self.pageCourante != parseInt($(".page").children(":last").text()) || e.keyCode == 50 && self.position != 10 && $("partMenu2").children(":div:eq(" + self.position + ")").html() != $("partMenu2").children("div:last").html()){
					if (e.keyCode == 48 && self.position == 0 && self.pageCourante != -1){
						self.pageCourante -= 1;
						self.position = 0;
						pageChange = true;
					}
					else if (e.keyCode == 48 && self.position != 0)
						self.position--;
					else if (e.keyCode == 50 && self.position == 10 && self.pageCourante != self.pageFin){
						self.pageCourante += 1;
						self.position = 0;
						pageChange = true;
					}
					else
						self.position++;
					if (pageChange){
						$("#pageCible").removeAttr("id");
						$(".page:eq(" + (self.pageCourante - 1) + ")").attr("id", "pageCible");
						self.menuCombat.afficherItems(indice, self.pageCourante, false);
					}
					else{
						(".spanVuePart2Menu").removeAttr("class");
						("#cadre2").children("div:eq(" + self.position + ")").attr("class", "spanVuePart2Menu");
					}
				}
				else{
					if (e.keyCode == 13){
						if (parseInt($("#barreVie").attr("value")) > parseInt($(".spanVuePart2Menu").children("span:eq(4)"))){
							//si le gars a assez de chakra
							$.post("ajax.php", {"coup" : "technique", "code" : $(".spanVuePart2Menu").children("span:eq(0)").text()}.done(function(datas){
								$("#barreChakra").attr("value", parseInt($("#barreChakra").attr("value")) - parseInt($(".spanVuePart2Menu").children("span:eq(4)")));
							});
						}
						else
							toastr.warning("Executer cette technique vous consommera tout votre chakra, execution de la technique impossible", "Attention !");
					}		
				}
			});
		}
		return MenuPartie2
	});
	//checked
	var MenuPartie1 = (function(){
		MenuPartie1.prototype.MenuPartie1 = function(menuCombatParam)[
			this.position = 0;
			this.menuCombat = menuCombatParam;
			this.partieMenu2 = new Partie2Menu(menuCombatParam);
			this.manipulationChakra = [["non", 0], ["non", 0], ["non", 0]];
		};
		MenuPartie1.prototype.init = function(){
			var self = this;
			$("#cadre1").keyup(function(e){
				if ((e.keyCode == 48 && self.position > 0) || (e.keyCode == 50 && self.position < $("#cadre1 span").size() - 2)){
					if (e.keyCode == 48)
						self.position--;
					else
						self.position++;
					$("#cadre1 span").removeAttr("class");
					$("#cadre1").children("span:eq(" + self.position + ")").attr("class", "spanCibleSourieMenuCombat");
				}
				else if (e.keyCode == 49 && $(".spanCibleSourieMenuCombat:eq(0)").parent().attr("id") == "rubriqueTechniquesEtObjets"){
					self.menuCombat.afficherItems(joueur.getItems(self.position), 0, true);
					self.partie2Menu.init();
				}
				else{
					if (e.keyCode == 13 && $(".spanCibleSourieMenuCombat:eq(" + self.position + ")").parent().attr("id") == "manipulationChakra")
						var number = parseInt($(".spanCibleSourieMenuCombat:eq(" + self.position + ")").text(.substring(11, 1)));
						var choix;
						if ($(".spanCibleSourieMenuCombat:eq(" + self.position + ")").attr("id").length == 12)
							self.manipulationChakra[number - 1][0] = "oui";
						else
							self.manipulationChakra[number - 1][0] = "non";
						if (self.manipulationChakra[number - 1][0] == "oui"){
							$("#content").append($("#ajouterChakraTemplate").html());
							$("#doseChakra").focus();
							$("#ajouterChakra button").click(function(){
								if ($(this).attr("id") == "annuler"){
									self.manipulationChakra[number - 1][0] = "non";
									$("#ajouterChakra").remove();
									$("#cadre1").focus();
								}
								else{
									if (parseInt($("#doseChakra").val()) >= 1){
										self.manipulationChakra[number - 1][1] = parseInt($("#doseChakra").val());
										$("#manipulationChakra span:eq(" + self.position + ")").attr("class", "actif");
										$("#manipulationChakra span:eq(" + self.position + ")").text($("#manipulationChakra span:eq(" + self.position + ")").text().replace("Intégrer", "Ajuster"));
										$("#manipulationChakra span:eq(" + self.position + ")").text($("#manipulationChakra span:eq(" + self.position + ")").text().replace("dans", "de"));
										$("#manipulationChakra span:eq(" + self.position + ")").text($("#manipulationChakra span:eq(" + self.position + ")").text().replace("du", "le"));
										$("#ajouterChakra").remove();
									}
									else{
										$("#doseChakra").attr("class", "champPasOk");
										$("#doseChakra").val("Entrez une valeur entre 1 et 100");
									}
								}
							});
						}
						else{
							$("#manipulationChakra span:eq(" + self.position + ")").attr("class", "inactif");
							$("#manipulationChakra span:eq(" + self.position + ")").text($("#manipulationChakra span:eq(" + (self.position - 3) + ")").text().replace("Ajuster", "Intégrer"));
							$("#manipulationChakra span:eq(" + self.position + ")").text($("#manipulationChakra span:eq(" + (self.position - 3) + ")").text().replace("de", "dans"));
							$("#manipulationChakra span:eq(" + self.position + ")").text($("#manipulationChakra span:eq(" + (self.position - 3) + ")").text().replace("le", "du"));	
						}
					}
					else{
						if (e.keyCode == 13 && $(".spanCibleSourieMenuCombat:eq(" + self.position + ")").parent().attr("id") == "coupsStandards")
							$.post("ajax.php", "coup" : "attaqueSimple", "chakraDansCoup" : self.manipulerChakra[0][0], "valeurChakraCoup" : self.manipulerChakra[0][1], "chakraDansPied" : self.manipulerChakra[1][0], "valeurChakraPieds" : self.manipulerChakra[1][1], "chakraDansCorps" : self.manipulerChakra[2][0], "valeurChakraDansCorps" : self.manipulerChakra[2][1], "typeAttaque" : $(".spanCibleSourieMenuCombat:eq(" + self.position + ")").attr("id"), "armePrincipale" : joueur.getArmePrincipale().getNom()});
						else{
							if (e.keyCode == 13 && $(".spanCibleSourieMenuCombat:eq(" + self.position + ")").parent().attr("id") == "changerArme")
								joueur.changeArmePrincipale(); 	
						}
					}
				}
			});
		};
		return MenuPartie1;
	});
	//checked
	var MenuCombat = (function(){
		
	MenuCombat.prototype.MenuCombat = function(lesTechniques, lesObjets){
		this.partie1Menu = new Partie1Menu(this);
		this.partie1Menu.init();
	};
	
	MenuCombat.prototype.afficherPageItems = function(indice, items){
		var self = this;
		$("#cadre2").children(":last").html("");
		for (var i = 0, c = parseInt(items.length / 10); i < c; i++){
			if (i == 0)
	    			$("#cadre2").children(":last").append("<span class=page id=pageCible>" + (i + 1) + "</span>");
			else
				$("#cadre2").children(":last").append("<span class=page>" + (i + 1) + "</span>"); 
		}
		if ($(".page").size() % 10 != 0)
			$("#cadre2").children(":last").children(":last").remove();
	};
	
	MenuCombat.prototype.afficherItems = function(indice, page, initialisation){
	$("#cadre2").children(":first").html();
	var fin = page * 10 + 10;
	var ressources = null;
	if (indice < 3)
		ressources = ["#templateTechnique", this.techniques[indice]];
	else{
		if (indice > 3)
			ressources = ["#templateObjet", this.objets];
	}
	if (fin > ressources[1].length)
		fin = ressources[1].length;
	for (var i = page * 10; i < fin; i++){
		$("#cadre2").children(":first").append($(ressources[0]).html());
		for (var b = 0, c = ressources[1][i].length; b < c; b++){
			$("#cadre2").children(":first").children(":last").children("span:eq(" + b + ")").text(ressources[1][i][b]);
		}       
	}
	if (initialisation)
		this.afficherPageItems(indice);
	};
	return MenuCombat;
});

</script>
